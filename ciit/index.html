<!DOCTYPE html>
<!-- Copyright (C) 2014 Mario Ampov, Stojan Dimitrovski, Andrej Kolarovski. All rights reserved. -->
<html>
  <head>
    <meta charset="utf-8">

    <title>RoboL</title>

    <link rel="stylesheet" href="style.css" />

    <script type="text/javascript" src="./assets/jquery-1.11.1.js"></script>
    <script type="text/javascript" src="./assets/codemirror/codemirror.js"></script>

    <script type="text/javascript">
      var RoboL = {};

      $(function() {
        RoboL.CODE = CodeMirror.fromTextArea(document.getElementById('code'), {
          mode: 'text/plain',
          lineNumbers: true
        });

        RoboL.RIMAL = CodeMirror.fromTextArea(document.getElementById('rimal'), {
          mode: 'text/plain',
          lineNumbers: false,
          readOnly: "nocursor"
        });

        RoboL.ENVIRONMENT = CodeMirror.fromTextArea(document.getElementById('environment'), {
          mode: 'text/plain',
          lineNumbers: true
        });

        $("#edit .environment").css({ display: 'none', visibility: 'hidden' });

        $('#m-animation a').click(function() {
          $('#preview .animation').css({ visibility: 'visible', display: 'block' });
          $('#preview .rimal').css({ visibility: 'hidden', display: 'none' });

          $('#m-animation').addClass('pure-menu-selected');
          $('#m-rimal').removeClass('pure-menu-selected');

          SCREEN.resize();
        });

        $('#m-rimal a').click(function() {
          $('#preview .rimal').css({ visibility: 'visible', display: 'block' });
          $('#preview .animation').css({ visibility: 'hidden', display: 'none' });

          $('#m-rimal').addClass('pure-menu-selected');
          $('#m-animation').removeClass('pure-menu-selected');

          RoboL.RIMAL.refresh();
        });

        $('#m-code a').click(function() {
          $('#edit .code').css({ visibility: 'visible', display: 'block' });
          $('#edit .environment').css({ visibility: 'hidden', display: 'none' });

          $('#m-code').addClass('pure-menu-selected');
          $('#m-environment').removeClass('pure-menu-selected');
        });

        $('#m-environment a').click(function() {
          $('#edit .code').css({ visibility: 'hidden', display: 'none' });
          $('#edit .environment').css({ visibility: 'visible', display: 'block' });

          $('#m-code').removeClass('pure-menu-selected');
          $('#m-environment').addClass('pure-menu-selected');
        });
      });
    </script>

    <script type="text/javascript" src="robol/lex/lex.js"></script>
    <script type="text/javascript" src="robol/lex/lexer.js"></script>
    <script type="text/javascript" src="robol/parser/parser.js"></script>
    <script type="text/javascript" src="robol/code_generator/code_generator.js"></script>
    <script type="text/javascript" src="robol/analyzer/analyzer.js"></script>

    <script type="text/javascript">
      var DATA = new function () {

        this.linesH = 2;
        this.linesV = 2;
        this.walls = [];
        this.coins = [];
        this.robot = [-Math.PI / 2, 1, 1];

        this.getDirection = function (x) {
          var tmp = {'и' : Math.PI, 'з' : 0, 'с' : Math.PI / 2, 'ј' : -Math.PI / 2};
          return tmp[x.toLowerCase()];
        }

      }
    </script>
    <script type="text/javascript" src="rimal/pixi.js"></script>
    <script type="text/javascript" src="rimal/parser.js"></script>
    <script type="text/javascript" src="rimal/interpreter.js"></script>
    <script type="text/javascript" src="rimal/screen.js"></script>

    <script type="text/javascript">
      $(function() {
        RoboL.Parser.yy.parseError = function(str, hash) {
          var description = "Грешка на <a href=\"#\" id=\"line-error\" data-line=\"" + hash.line + "\">линија " + (hash.line + 1) + "</a>. ";

          if (hash.token) {
            description += '<br/> Неочекуван жетон <span class="token">' + hash.token + "</span>.";
          }

          $("#error").html(description);

          $("#line-error").click(function() {
            var line = parseInt($("#line-error").data('line'));

            RoboL.CODE.setCursor(parseInt($("#line-error").data('line')), 0);
            RoboL.CODE.focus();
          });

          RoboL.CODE.setCursor(hash.line, 0);
          RoboL.CODE.focus();

          throw new Error(str);
        };

        RoboL.compile = function compile() {
          if (!/[^ \n\t\r]/m.test(RoboL.ENVIRONMENT.getValue())) {
            $("#error").html("Немате дефинирано околина!");

            $("#m-environment a").click();

            return false;
          }

          if (!/[^ \n\t\r]/m.test(RoboL.CODE.getValue())) {
            $("#error").html("Нема код за компајлирање!");

            $("#m-code a").click();

            return false;
          }

          try {
            PARSER.parseEnv(RoboL.ENVIRONMENT.getValue());
          } catch (error) {
            $("#error").html(error.message);

            $("#m-environment a").click();

            return false;
          }

          RoboL.Parser.lexer = new RoboL.Lexer;

          var input = RoboL.CODE.getValue()
            , ast = null;

          try {
            ast = RoboL.Parser.parse(input);
          } catch (error) {
            return false;
          }

          var analyzer = new RoboL.SemanticAnalyzer
            , errors = analyzer.run(ast);

          if (errors.length > 1) {
            $("#error").html(errors.slice(0, -1).join("<br/>"));

            return false;
          }

          var codeGenerator = new RoboL.CodeGenerator
            , rimal = codeGenerator.generateCode(ast);

          RoboL.RIMAL.setValue(rimal.join("\n"));

          $("#error").html("");

          return true;
        };

        RoboL.run = function run() {
          RoboL.stop();

          if (RoboL.compile()) {
            INTERPRETER.setCode(RoboL.RIMAL.getValue().split("\n"));
            INTERPRETER.run();

            $("#m-animation a").click();

            $("#run").addClass("pure-button-active");
            $("#stop").removeClass("pure-button-disabled");
          }
        };

        RoboL.stop = function stop() {
          INTERPRETER.stop();

          $("#run").removeClass("pure-button-active");
          $("#stop").addClass("pure-button-disabled");
        };

        $("#compile").click(function() {
          RoboL.compile();
        });

        $("#run").click(function() {
          RoboL.run();
        });

        $("#stop").click(function() {
          RoboL.stop();
        });
      });
    </script>
  </head>
  <body class="pure-skin-robol">
    <div class="pure-g">
      <header class="pure-u-1 l-box">
        <h1>RoboL околина</h1>
      </header>
    </div>

    <div class="pure-g">
      <div class="pure-u-3-5 l-box">
        <div class="pure-g">
          <div class="pure-u-1-2">
            <button id="compile" class="pure-button pure-button-primary button-small"><i class="fa fa-bolt"></i>&nbsp;Компајлирај</button>
            <button id="run" class="pure-button button-small"><i class="fa fa-play"></i></button>
            <button id="stop" class="pure-button button-small pure-button-disabled"><i class="fa fa-stop"></i></button>
          </div>

          <div class="pure-u-1-2">

            <div class="pure-menu pure-menu-open pure-menu-horizontal">
              <a class="pure-menu-heading">Уреди</a>

              <ul>
                <li id="m-code" class="pure-menu-selected"><a href="#">Код</a></li>
                <li id="m-environment"><a href="#">Околина</a></li>
              </ul>
            </div>

          </div>
        </div>
      </div>

      <div class="pure-u-2-5 l-box">
        <div class="pure-menu pure-menu-open pure-menu-horizontal">
          <a class="pure-menu-heading">Преглед</a>

          <ul>
            <li id="m-rimal" class="pure-menu-selected"><a href="#">Rimal</a></li>
            <li id="m-animation"><a href="#">Анимација</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="pure-g">
      <div id="edit" class="pure-u-3-5 l-box">
        <div class="code">
          <textarea id="code"></textarea>
        </div>

        <div class="environment">
          <textarea id="environment">
околина (2,2)

ѕидови
почеток
крај

ознаки
почеток
крај

робот ј(1,1)
          </textarea>
        </div>


        <div id="error">
        </div>
      </div>

      <div id="preview" class="pure-u-2-5 l-box">
        <div class="rimal pure-g">
          <textarea id="rimal"></textarea>
        </div>

        <div class="animation pure-g" style="visibility: hidden; display: none;">
          <div id="simulation"></div>
        </div>
      </div>
    </div>

    <div class="pure-g">
      <footer class="pure-u-1 l-box">
        Авторски права &copy; 2014 Марио Ампов, Стојан Димитровски, Андреј Коларовски. Сите права задржани.
      </footer>
    </div>
  </body>
</html>
